<div class="app">
    <main class="content">
        <!-- Search Section -->
        <div class="search-section">
            <h2>Search</h2>
            <div class="search-form">
                <div class="search-column">
                    <div class="form-group">
                        <label>Keyword</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.keyword">
                    </div>
                    <div class="form-group">
                        <label>Building</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.building">
                    </div>
                    <div class="form-group">
                        <label>Building Group</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.buildingGroup">
                    </div>
                    <div class="form-group">
                        <label>Device Name</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.deviceName">
                    </div>
                </div>
                <div class="search-column">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.city">
                    </div>
                    <div class="form-group">
                        <label>Zip Code</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.zipCode">
                    </div>
                    <div class="form-group">
                        <label>Tenant</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.tenant">
                    </div>
                    <div class="form-group">
                        <label>Tenant ID</label>
                        <input type="text" placeholder="" [(ngModel)]="searchData.tenantId">
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Section -->
        <div class="middle-section">
            <!-- Building Groups Section -->
            <div class="building-groups-section">
                <h3>Building Groups</h3>
                <div class="groups-panel">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Group</th>
                                <th>Building</th>
                                <th>Zip Code</th>
                                <th>Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let group of paginatedBuildingGroups; let i = index" 
                                (click)="onGroupRowClick((currentGroupPage - 1) * itemsPerPage + i)" 
                                [class.selected]="selectedGroupRow === (currentGroupPage - 1) * itemsPerPage + i">
                                <td>{{ (currentGroupPage - 1) * itemsPerPage + i + 1 }}</td>
                                <td>{{ group.group_name || 'N/A' }}</td>
                                <td>{{ group.buildings?.[0]?.building_name || 'N/A' }}</td>
                                <td>{{ group.buildings?.[0]?.zip_code || 'N/A' }}</td>
                                <td>{{ (group.buildings?.[0]?.street_number || '') + ' ' + (group.buildings?.[0]?.additional_address || '') || 'N/A' }}</td>
                            </tr>
                        </tbody>
                    </table>
                <div class="action-buttons">
                    <div class="action-buttons-left">
                        <button class="pill" (click)="addGroup()">Add Group</button>
                        <button class="pill outline danger" (click)="removeGroup()">Delete Group</button>
                    </div>
                    
                    <!-- Pagination for Building Groups -->
                    <div class="pagination-inline" *ngIf="totalGroupPages > 1">
                        <div class="pagination-info">
                            {{ (currentGroupPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentGroupPage * itemsPerPage, buildingGroups.length) }} of {{ buildingGroups.length }}
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" 
                                    [disabled]="currentGroupPage === 1" 
                                    (click)="onGroupPageChange(currentGroupPage - 1)">
                                ‹
                            </button>
                            <button *ngFor="let page of getGroupPageNumbers()" 
                                    class="pagination-btn" 
                                    [class.active]="page === currentGroupPage"
                                    (click)="onGroupPageChange(page)">
                                {{ page }}
                            </button>
                            <button class="pagination-btn" 
                                    [disabled]="currentGroupPage === totalGroupPages" 
                                    (click)="onGroupPageChange(currentGroupPage + 1)">
                                ›
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Building / Apartment Section -->
            <div class="building-apartment-section">
                <h3>Building / Apartment</h3>
                <div class="apartment-panel">
                    <div class="kv-grid">
                        <div class="kv-row">
                            <span class="kv-label">Building Group</span>
                            <span class="kv-value">{{ getSelectedApartment()?.buildings?.building_groups?.group_name || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Building</span>
                            <span class="kv-value">{{ getSelectedApartment()?.buildings?.building_name || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Apartment</span>
                            <span class="kv-value">{{ getSelectedApartment()?.apartment_number || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Street</span>
                            <span class="kv-value">{{ (getSelectedApartment()?.buildings?.street_number || '') + ' ' + (getSelectedApartment()?.buildings?.additional_address || '') || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Tenant</span>
                            <span class="kv-value">{{ getSelectedTenant()?.first_name + ' ' + getSelectedTenant()?.last_name || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Telephone</span>
                            <span class="kv-value">{{ getSelectedTenant()?.phone || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Mobile Phone</span>
                            <span class="kv-value">{{ getSelectedTenant()?.mobile_phone || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Email</span>
                            <span class="kv-value">{{ getSelectedTenant()?.email || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Water Price</span>
                            <span class="kv-value">{{ getSelectedApartment()?.water_price_per_m3 || 'N/A' }} Euro /m3</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Zip Code</span>
                            <span class="kv-value">{{ getSelectedApartment()?.buildings?.zip_code || 'N/A' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">City</span>
                            <span class="kv-value">{{ getSelectedApartment()?.buildings?.cities?.name || 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="pill" (click)="addApartment()">Add Apartment</button>
                        <button class="pill outline" (click)="saveDetails()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Building Section -->
        <div class="building-section">
            <h3>Building</h3>
            <div class="building-panel">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Building</th>
                            <th>Zip Code</th>
                            <th>Address</th>
                            <th>Apartment</th>
                            <th>Tenant</th>
                        </tr>
                    </thead>
                        <tbody>
                            <tr *ngFor="let building of paginatedBuildings; let i = index" 
                                (click)="onBuildingRowClick((currentBuildingPage - 1) * itemsPerPage + i)" 
                                [class.selected]="selectedBuildingRow === (currentBuildingPage - 1) * itemsPerPage + i">
                                <td>{{ (currentBuildingPage - 1) * itemsPerPage + i + 1 }}</td>
                                <td>{{ building.building_name || 'N/A' }}</td>
                                <td>{{ building.zip_code || 'N/A' }}</td>
                                <td>{{ (building.street_number || '') + ' ' + (building.additional_address || '') || 'N/A' }}</td>
                                <td>{{ building.apartments?.[0]?.apartment_number || 'N/A' }}</td>
                                <td>{{ building.apartments?.[0]?.tenants?.first_name + ' ' + building.apartments?.[0]?.tenants?.last_name || 'N/A' }}</td>
                            </tr>
                        </tbody>
                </table>
                <div class="action-buttons">
                    <div class="action-buttons-left">
                        <button class="pill" (click)="addBuilding()">Add Building</button>
                        <button class="pill outline danger" (click)="removeBuilding()">Delete Building</button>
                    </div>
                    
                    <!-- Pagination for Buildings -->
                    <div class="pagination-inline" *ngIf="totalBuildingPages > 1">
                        <div class="pagination-info">
                            {{ (currentBuildingPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentBuildingPage * itemsPerPage, buildings.length) }} of {{ buildings.length }}
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" 
                                    [disabled]="currentBuildingPage === 1" 
                                    (click)="onBuildingPageChange(currentBuildingPage - 1)">
                                ‹
                            </button>
                            <button *ngFor="let page of getBuildingPageNumbers()" 
                                    class="pagination-btn" 
                                    [class.active]="page === currentBuildingPage"
                                    (click)="onBuildingPageChange(page)">
                                {{ page }}
                            </button>
                            <button class="pagination-btn" 
                                    [disabled]="currentBuildingPage === totalBuildingPages" 
                                    (click)="onBuildingPageChange(currentBuildingPage + 1)">
                                ›
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Building Group Modal -->
    <app-modal 
        [isOpen]="showAddGroupModal" 
        title="Add Building Group"
        size="medium"
        (close)="onModalClose()">
        
        <app-building-group-form 
            (success)="onGroupSaved($event)"
            (cancel)="onModalClose()">
        </app-building-group-form>
        
    </app-modal>

    <!-- Add Building Modal -->
    <app-modal 
        [isOpen]="showAddBuildingModal" 
        title="Add Building"
        size="large"
        (close)="onBuildingModalClose()">
        
        <app-building-form 
            [selectedGroupId]="selectedGroupRow !== null ? buildingGroups[selectedGroupRow].id || null : null"
            (success)="onBuildingSaved($event)"
            (cancel)="onBuildingModalClose()">
        </app-building-form>
        
    </app-modal>

    <!-- Delete Confirmation Modal -->
    <app-confirmation-modal
        [isOpen]="showDeleteConfirmation"
        [title]="deleteConfirmationData?.type === 'building' ? 'Delete Building' : 'Delete Building Group'"
        [message]="deleteConfirmationData?.type === 'building' 
            ? 'Are you sure you want to delete &quot;' + (deleteConfirmationData?.item?.building_name || '') + '&quot;? This action cannot be undone.'
            : 'Are you sure you want to delete &quot;' + (deleteConfirmationData?.item?.group_name || '') + '&quot;? This will also delete all buildings in this group. This action cannot be undone.'"
        [confirmText]="isDeleting ? 'Deleting...' : 'Delete'"
        [cancelText]="'Cancel'"
        [type]="'danger'"
        [isLoading]="isDeleting"
        (confirm)="onDeleteConfirm()"
        (cancel)="onDeleteCancel()">
    </app-confirmation-modal>
</div>
