<div class="app">
    <main class="content">
        <!-- Search Section -->
        <div class="search-section">
            <h2>Search</h2>
            <div class="search-form">
                <div class="search-column">
                    <div class="form-group">
                        <label>Keyword</label>
                        <input type="text" placeholder="Search across all data..." [(ngModel)]="searchData.keyword" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Building</label>
                        <input type="text" placeholder="Filter by building name..." [(ngModel)]="searchData.building" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Building Group</label>
                        <input type="text" placeholder="Filter by group name..." [(ngModel)]="searchData.buildingGroup" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Device Name</label>
                        <input type="text" placeholder="Filter by device..." [(ngModel)]="searchData.deviceName" (input)="onSearch()">
                    </div>
                </div>
                <div class="search-column">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" placeholder="Filter by city..." [(ngModel)]="searchData.city" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Zip Code</label>
                        <input type="text" placeholder="Filter by zip code..." [(ngModel)]="searchData.zipCode" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Tenant</label>
                        <input type="text" placeholder="Filter by tenant name..." [(ngModel)]="searchData.tenant" (input)="onSearch()">
                    </div>
                    <div class="form-group">
                        <label>Tenant ID</label>
                        <input type="text" placeholder="Filter by tenant ID..." [(ngModel)]="searchData.tenantId" (input)="onSearch()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Section -->
        <div class="middle-section">
            <!-- Building Groups Section -->
            <div class="building-groups-section">
                <h3>Building Groups</h3>
                <div class="groups-panel">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Group</th>
                                <th>Building</th>
                                <th>Zip Code</th>
                                <th>Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let group of paginatedBuildingGroups; let i = index" 
                                (click)="onGroupRowClick((currentGroupPage - 1) * itemsPerPage + i)" 
                                (dblclick)="onGroupRowDoubleClick((currentGroupPage - 1) * itemsPerPage + i)"
                                [class.selected]="selectedGroupRow === (currentGroupPage - 1) * itemsPerPage + i">
                                <td>{{ (currentGroupPage - 1) * itemsPerPage + i + 1 }}</td>
                                <td>{{ group.name || 'N/A' }}</td>
                                <td>{{ group.address || 'N/A' }}</td>
                                <td>{{ group.address?.split(',')[1]?.trim() || 'N/A' }}</td>
                                <td>{{ group.address || 'N/A' }}</td>
                            </tr>
                        </tbody>
                    </table>
                <div class="action-buttons">
                    <div class="action-buttons-left">
                        <button class="pill" (click)="openAddGroupModal()">Add Group</button>
                        <button class="pill outline danger" 
                                (click)="openDeleteGroupModal()"
                                [disabled]="selectedGroupRow === null">Delete Group</button>
                    </div>
                    
                    <!-- Pagination for Building Groups -->
                    <div class="pagination-inline" *ngIf="buildingGroupTotalPages > 1">
                        <div class="pagination-info">
                            Showing {{ (currentGroupPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentGroupPage * itemsPerPage, buildingGroupTotalItems) }} of {{ buildingGroupTotalItems }} groups
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" 
                                    [disabled]="currentGroupPage === 1" 
                                    (click)="onGroupPageChange(currentGroupPage - 1)">
                                ‹
                            </button>
                            <button *ngFor="let page of getGroupPageNumbers()" 
                                    class="pagination-btn" 
                                    [class.active]="page === currentGroupPage"
                                    (click)="onGroupPageChange(page)">
                                {{ page }}
                            </button>
                            <button class="pagination-btn" 
                                    [disabled]="currentGroupPage === buildingGroupTotalPages" 
                                    (click)="onGroupPageChange(currentGroupPage + 1)">
                                ›
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Building / Apartment Section -->
            <div class="building-apartment-section">
                <h3>Building / Apartment</h3>
                <div class="apartment-panel">
                    <div class="kv-grid">
                        <div class="kv-row">
                            <span class="kv-label">Building Group</span>
                            <span class="kv-value">{{ getSelectedBuildingGroup()?.name || 'Groupe Immobilier Paris Centre' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Building</span>
                            <span class="kv-value">{{ getSelectedBuilding()?.name || 'Résidence Vendôme' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Apartment</span>
                            <span class="kv-value">{{ getSelectedApartment()?.number || 'Apt 101' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Street</span>
                            <span class="kv-value">{{ getSelectedBuilding()?.address || '15 Place Vendôme, 75001 Paris' }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Tenant</span>
                            <span class="kv-value">{{ getSelectedTenant()?.first_name + ' ' + getSelectedTenant()?.last_name }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Telephone</span>
                            <span class="kv-value">{{ getSelectedTenant()?.phone }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Mobile Phone</span>
                            <span class="kv-value">{{ getSelectedTenant()?.mobile_phone }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Email</span>
                            <span class="kv-value">{{ getSelectedTenant()?.email }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Water Price</span>
                            <span class="kv-value">{{ getSelectedApartment()?.water_price_per_m3 }} Euro /m3</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">Zip Code</span>
                            <span class="kv-value">{{ getSelectedBuilding()?.zip_code || getSelectedBuilding()?.address?.split(',')[1]?.trim() }}</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">City</span>
                            <span class="kv-value">{{ getSelectedBuilding()?.city || getSelectedBuilding()?.address?.split(',')[0]?.trim() }}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <div class="action-buttons-left">
                            <button class="pill outline" (click)="editBuildingApartmentDetails()" [disabled]="!getSelectedBuilding()">Edit Details</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Building and Apartment Grids Section -->
        <div class="building-apartment-grids-section">
            <!-- Building Section -->
            <div class="building-section">
                <h3>Building</h3>
                <div class="building-panel">
                    <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Building Name</th>
                                        <th>Address</th>
                                        <th>Zip Code</th>
                                        <th>Apartments</th>
                                        <th>Devices</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let building of paginatedBuildings; let i = index" 
                                        (click)="onBuildingRowClick(i)" 
                                        (dblclick)="onBuildingRowDoubleClick(i)"
                                        [class.selected]="selectedBuildingRow === i">
                                        <td>{{ (currentBuildingPage - 1) * itemsPerPage + i + 1 }}</td>
                                        <td>{{ building.name || 'N/A' }}</td>
                                        <td>{{ building.address || 'N/A' }}</td>
                                        <td>{{ building.zip_code || 'N/A' }}</td>
                                        <td>{{ building.apartmentCount || 'N/A' }}</td>
                                        <td>{{ building.deviceCount || 'N/A' }}</td>
                                    </tr>
                                </tbody>
                </table>
                <div class="action-buttons">
                    <div class="action-buttons-left">
                        <button class="pill" (click)="openAddBuildingModal()">Add Building</button>
                        <button class="pill outline danger" 
                                (click)="openDeleteBuildingModal()"
                                [disabled]="selectedBuildingRow === null">Delete Building</button>
                    </div>
                    
                    <!-- Pagination for Buildings -->
                    <div class="pagination-inline" *ngIf="buildingTotalPages > 1">
                        <div class="pagination-info">
                            Showing {{ (currentBuildingPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentBuildingPage * itemsPerPage, buildingTotalItems) }} of {{ buildingTotalItems }} buildings
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" 
                                    [disabled]="currentBuildingPage === 1" 
                                    (click)="onBuildingPageChange(currentBuildingPage - 1)">
                                ‹
                            </button>
                            <button *ngFor="let page of getBuildingPageNumbers()" 
                                    class="pagination-btn" 
                                    [class.active]="page === currentBuildingPage"
                                    (click)="onBuildingPageChange(page)">
                                {{ page }}
                            </button>
                            <button class="pagination-btn" 
                                    [disabled]="currentBuildingPage === buildingTotalPages" 
                                    (click)="onBuildingPageChange(currentBuildingPage + 1)">
                                ›
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Apartment Grid Section -->
            <div class="apartment-grid-section">
                <h3>Apartment</h3>
                <div class="apartment-grid-panel">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Apartment</th>
                                <th>Tenant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let apartment of apartmentGridData; let i = index" 
                                (click)="onApartmentRowClick(i)" 
                                (dblclick)="onApartmentRowDoubleClick(i)"
                                [class.selected]="selectedApartmentRow === i">
                                <td>{{ (apartmentCurrentPage - 1) * itemsPerPage + i + 1 }}</td>
                                <td>{{ apartment.apartment }}</td>
                                <td>{{ apartment.tenant }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="action-buttons">
                        <div class="action-buttons-left">
                            <button class="pill" (click)="openAddApartmentModal()">Add Apartment</button>
                            <button class="pill outline danger" 
                                    (click)="openDeleteApartmentModal()"
                                    [disabled]="selectedApartmentRow === null">Delete Apartment</button>
                        </div>
                        
                        <!-- Pagination for Apartments - on same line as buttons -->
                        <div class="pagination-inline" *ngIf="apartmentTotalPages > 1">
                            <div class="pagination-controls">
                                <button class="pagination-btn" 
                                        [disabled]="apartmentCurrentPage === 1" 
                                        (click)="onApartmentPageChange(apartmentCurrentPage - 1)">
                                    ‹
                                </button>
                                <button *ngFor="let page of getApartmentPageNumbers()" 
                                        class="pagination-btn" 
                                        [class.active]="page === apartmentCurrentPage"
                                        (click)="onApartmentPageChange(page)">
                                    {{ page }}
                                </button>
                                <button class="pagination-btn" 
                                        [disabled]="apartmentCurrentPage === apartmentTotalPages" 
                                        (click)="onApartmentPageChange(apartmentCurrentPage + 1)">
                                    ›
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Building Group Modal -->
    <app-modal 
        [isOpen]="showAddGroupModal" 
        title="Add Building Group"
        size="medium"
        (close)="onModalClose()">
        
        <app-building-group-form 
            (success)="onGroupSaved($event)"
            (cancel)="onModalClose()">
        </app-building-group-form>
        
    </app-modal>

    <!-- Add Building Modal -->
    <app-modal 
        [isOpen]="showAddBuildingModal" 
        title="Add Building"
        size="large"
        (close)="onBuildingModalClose()">
        
        <app-building-form 
            [selectedGroupId]="selectedGroupRow !== null ? buildingGroups[selectedGroupRow].id || null : null"
            (success)="onBuildingSaved($event)"
            (cancel)="onBuildingModalClose()">
        </app-building-form>
        
    </app-modal>

    <!-- Update Building Modal -->
    <app-modal 
        [isOpen]="showUpdateBuildingModal" 
        title="Update Building"
        size="large"
        (close)="onUpdateBuildingModalClose()">
        
        <app-building-form 
            [isEditMode]="true"
            [buildingData]="selectedBuildingForEdit"
            [selectedGroupId]="selectedBuildingForEdit?.building_group_id || null"
            (success)="onBuildingUpdated($event)"
            (cancel)="onUpdateBuildingModalClose()">
        </app-building-form>
        
    </app-modal>

    <!-- Delete Confirmation Modal -->
    <app-confirmation-modal
        [isOpen]="showDeleteConfirmation"
        [title]="deleteConfirmationData?.type === 'building' ? 'Delete Building' : 'Delete Building Group'"
        [message]="deleteConfirmationData?.type === 'building' 
            ? 'Are you sure you want to delete &quot;' + (deleteConfirmationData?.item?.building_name || '') + '&quot;? This action cannot be undone.'
            : 'Are you sure you want to delete &quot;' + (deleteConfirmationData?.item?.group_name || '') + '&quot;? This will also delete all buildings in this group. This action cannot be undone.'"
        [confirmText]="isDeleting ? 'Deleting...' : 'Delete'"
        [cancelText]="'Cancel'"
        [type]="'danger'"
        [isLoading]="isDeleting"
        (confirm)="onDeleteConfirm()"
        (cancel)="onDeleteCancel()">
    </app-confirmation-modal>

    <!-- Building Group Modal -->
    <app-building-group-modal
        [isVisible]="showModal"
        [modalType]="modalType"
        [groupName]="modalGroupName"
        [isLoading]="modalLoading"
        [itemType]="modalItemType"
        (save)="onModalSave($event)"
        (cancel)="onModalCancel()">
    </app-building-group-modal>

    <!-- Data Modal for Buildings and Apartments -->
    <app-data-modal
        [isVisible]="showDataModal"
        [modalType]="dataModalType"
        [itemType]="dataModalItemType"
        [formData]="dataModalFormData"
        [isLoading]="dataModalLoading"
        [fieldConfigs]="dataModalFieldConfigs"
        [deleteItemName]="dataModalDeleteItemName"
        (save)="onDataModalSave($event)"
        (cancel)="onDataModalCancel()">
    </app-data-modal>
</div>
