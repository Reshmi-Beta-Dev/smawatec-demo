<div class="app">
    <main class="content">
        <!-- Alarm Summary Section -->
        <div class="alarm-summary">
            <!-- Major Alarms -->
            <div class="alarm-section major-alarms-section">
                <h3>Major Alarms</h3>
                <div class="summary-panel major-alarms">
                    <div class="alarm-stats">
                        <div class="stat-item">
                            <span class="stat-label">Major Leaks</span>
                            <span class="stat-value highlight">{{ getAlarmCount('major_leak') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">auto shut-off non resolved</span>
                            <span class="stat-value highlight">{{ getAlarmCount('auto_shutoff') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Low Temperature</span>
                            <span class="stat-value highlight">{{ getAlarmCount('low_temperature') }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Minor Alarms -->
            <div class="alarm-section minor-alarms-section">
                <h3>Minor Alarms</h3>
                <div class="summary-panel minor-alarms">
                    <div class="alarm-stats">
                        <div class="stat-item">
                            <span class="stat-label">Medium Leaks</span>
                            <span class="stat-value highlight">{{ getAlarmCount('medium_leak') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Minor Leaks</span>
                            <span class="stat-value highlight">{{ getAlarmCount('micro_leak') }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Messages -->
            <div class="alarm-section system-messages-section">
                <h3>System Messages</h3>
                <div class="summary-panel system-messages">
                    <div class="alarm-stats">
                        <div class="stat-item">
                            <span class="stat-label">Wifi Connection Lost</span>
                            <span class="stat-value highlight">{{ getAlarmCount('wifi_connection_lost') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Power Loss</span>
                            <span class="stat-value">{{ getAlarmCount('power_loss') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Valve Failure</span>
                            <span class="stat-value">{{ getAlarmCount('valve_failure') }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">poor Wifi</span>
                            <span class="stat-value highlight">{{ getAlarmCount('poor_wifi') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Board Section -->
        <div class="message-board-section">
            <div class="section-header">
                <h2>Message Board</h2>
            </div>
            <div class="table-container">
                <!-- Loading State -->
                <div *ngIf="loading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading alarms...</p>
                </div>
                
                <!-- Error State -->
                <div *ngIf="error && !loading" class="error-state">
                    <p>{{ error }}</p>
                    <button class="pill" (click)="loadAlarmMessages()">Retry</button>
                </div>
                
                <!-- Data Table -->
                <table *ngIf="!loading && !error" class="message-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Building</th>
                            <th>Address</th>
                            <th>Apartment</th>
                            <th>Tenant</th>
                            <th>Alarm</th>
                            <th>Message</th>
                            <th>Action</th>
                            <th class="action-header">
                                <button class="pill outline" (click)="showHiddenAlarms()" *ngIf="hiddenAlarmIds.size > 0">Show Hidden Alarms</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let alarm of alarms; let i = index" 
                            class="alarm-row" 
                            [class.critical]="alarm.alarm_type === 'major_leak'"
                            [class.major]="alarm.alarm_type === 'major_leak'"
                            [class.medium]="alarm.alarm_type === 'medium_leak'"
                            [class.micro]="alarm.alarm_type === 'micro_leak'"
                            [class.low-temp]="alarm.alarm_type === 'low_temperature'"
                            (click)="onRowClick(i)" 
                            [class.selected]="selectedRow === i">
                            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                            <td>{{ alarm.devices?.apartments?.buildings?.building_name || 'N/A' }}</td>
                            <td>{{ alarm.building_address || 'N/A' }}</td>
                            <td>{{ alarm.devices?.apartments?.apartment_number || 'N/A' }}</td>
                            <td>{{ getTenantName(alarm) }}</td>
                            <td>
                                <span class="alarm-badge" 
                                      [class.major]="alarm.alarm_severity === 'high'"
                                      [class.medium]="alarm.alarm_severity === 'medium'"
                                      [class.micro]="alarm.alarm_severity === 'low'"
                                      [class.low-temp]="alarm.alarm_type_name && alarm.alarm_type_name.toLowerCase().includes('temperature')">
                                    {{ alarm.alarm_type_name || 'Unknown' }}
                                </span>
                            </td>
                            <td>{{ alarm.message || 'N/A' }}</td>
                            <td>{{ alarm.action_taken || 'None' }}</td>
        <td class="actions" (click)="$event.stopPropagation()">
          <button class="pill" (click)="showDetails($event, alarm)">Details</button>
          <button class="pill outline" (click)="hideAlarm($event, alarm.id)">Hide Alarm</button>
        </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Pagination Controls Inside Grid -->
                <div class="pagination-inline" *ngIf="totalPages > 1 && !loading && !error">
                    <div class="pagination-info">
                        Showing {{ (currentPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} alarms
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" 
                                [disabled]="currentPage === 1" 
                                (click)="onPageChange(currentPage - 1)">
                            ‹
                        </button>
                        <button *ngFor="let page of getPageNumbers()" 
                                class="pagination-btn" 
                                [class.active]="page === currentPage"
                                (click)="onPageChange(page)">
                            {{ page }}
                        </button>
                        <button class="pagination-btn" 
                                [disabled]="currentPage === totalPages" 
                                (click)="onPageChange(currentPage + 1)">
                            ›
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Alarm Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Alarm Details</h3>
            <button class="close-button" (click)="closeDetailsModal()">&times;</button>
        </div>
        
        <div class="modal-body" *ngIf="selectedAlarmForDetails">
            <div class="details-grid">
                <!-- Alarm Information -->
                <div class="detail-section">
                    <h4>Alarm Information</h4>
                    <div class="detail-row">
                        <span class="detail-label">Alarm Type:</span>
                        <span class="detail-value alarm-type" [class.high]="selectedAlarmForDetails.alarm_severity === 'high'">
                            {{ selectedAlarmForDetails.alarm_type_name || 'Unknown' }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Severity:</span>
                        <span class="detail-value alarm-severity" [class.high]="selectedAlarmForDetails.alarm_severity === 'high'">
                            {{ selectedAlarmForDetails.alarm_severity || 'Unknown' }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value alarm-status" [class.active]="selectedAlarmForDetails.status === 'active'">
                            {{ selectedAlarmForDetails.status || 'Unknown' }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Message:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.message || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Action Taken:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.action_taken || 'None' }}</span>
                    </div>
                </div>

                <!-- Location Information -->
                <div class="detail-section">
                    <h4>Location Information</h4>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.building_address || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Apartment:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.apartment_id || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Floor:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.floor_number || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Room:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.room_number || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Tenant:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.tenant || 'N/A' }}</span>
                    </div>
                </div>

                <!-- Device Information -->
                <div class="detail-section">
                    <h4>Device Information</h4>
                    <div class="detail-row">
                        <span class="detail-label">Device Type:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.device_type || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Device ID:</span>
                        <span class="detail-value">{{ selectedAlarmForDetails.device_id || 'N/A' }}</span>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="detail-section">
                    <h4>Timeline</h4>
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">{{ formatDate(selectedAlarmForDetails.created_at) }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Resolved:</span>
                        <span class="detail-value">{{ formatDate(selectedAlarmForDetails.resolved_at || '') }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value">{{ getAlarmDuration(selectedAlarmForDetails) }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="pill outline" (click)="closeDetailsModal()">Close</button>
            <button class="pill" (click)="hideAlarm($event, selectedAlarmForDetails?.id || '')" *ngIf="selectedAlarmForDetails">Hide Alarm</button>
        </div>
    </div>
</div>
